<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Lesson 8 Advanced Topics | eBird Best Practices I</title>
  <meta name="description" content="Lesson 8 Advanced Topics | eBird Best Practices I: eBird Data Extraction and Processing in R" />
  <meta name="generator" content="bookdown 0.11.1 and GitBook 2.6.7" />

  <meta property="og:title" content="Lesson 8 Advanced Topics | eBird Best Practices I" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Lesson 8 Advanced Topics | eBird Best Practices I: eBird Data Extraction and Processing in R" />
  <meta name="github-repo" content="mstrimas/ebp-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Lesson 8 Advanced Topics | eBird Best Practices I" />
  
  <meta name="twitter:description" content="Lesson 8 Advanced Topics | eBird Best Practices I: eBird Data Extraction and Processing in R" />
  

<meta name="author" content="Matthew Strimas-Mackey, Alison Johnston, Wesley M. Hochachka, Viviana Ruiz-Gutierrez, Orin J. Robinson, Eliot T. Miller, Tom Auer, Steve Kelling, Daniel Fink" />


<meta name="date" content="2019-06-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="applications.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="assets/css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">eBird Best Practices Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>2</b> Setup</a><ul>
<li class="chapter" data-level="2.1" data-path="setup.html"><a href="setup.html#setup-tidyverse"><i class="fa fa-check"></i><b>2.1</b> Tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="access.html"><a href="access.html"><i class="fa fa-check"></i><b>3</b> Data Access</a></li>
<li class="chapter" data-level="4" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>4</b> Filtering</a><ul>
<li class="chapter" data-level="4.1" data-path="filter.html"><a href="filter.html#filter-define"><i class="fa fa-check"></i><b>4.1</b> Defining filters</a><ul>
<li class="chapter" data-level="4.1.1" data-path="filter.html"><a href="filter.html#filter-define-complete"><i class="fa fa-check"></i><b>4.1.1</b> Complete checklists</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="filter.html"><a href="filter.html#filter-execute"><i class="fa fa-check"></i><b>4.2</b> Execute filters</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="import.html"><a href="import.html"><i class="fa fa-check"></i><b>5</b> Importing Data</a><ul>
<li class="chapter" data-level="5.1" data-path="import.html"><a href="import.html#import-group"><i class="fa fa-check"></i><b>5.1</b> Group checklists</a></li>
<li class="chapter" data-level="5.2" data-path="import.html"><a href="import.html#import-taxonomy"><i class="fa fa-check"></i><b>5.2</b> Taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="presabs.html"><a href="presabs.html"><i class="fa fa-check"></i><b>6</b> Presence-absence Data</a><ul>
<li class="chapter" data-level="6.1" data-path="presabs.html"><a href="presabs.html#presabs-filter"><i class="fa fa-check"></i><b>6.1</b> Filtering</a></li>
<li class="chapter" data-level="6.2" data-path="presabs.html"><a href="presabs.html#presabs-zerofill"><i class="fa fa-check"></i><b>6.2</b> Zero-filling</a></li>
<li class="chapter" data-level="6.3" data-path="presabs.html"><a href="presabs.html#presabs-tidy"><i class="fa fa-check"></i><b>6.3</b> Tidying up</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="applications.html"><a href="applications.html"><i class="fa fa-check"></i><b>7</b> Applications</a><ul>
<li class="chapter" data-level="7.1" data-path="applications.html"><a href="applications.html#applications-trajectory"><i class="fa fa-check"></i><b>7.1</b> Frequency trajectories</a></li>
<li class="chapter" data-level="7.2" data-path="applications.html"><a href="applications.html#applications-maps"><i class="fa fa-check"></i><b>7.2</b> Maps</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="advanced.html"><a href="advanced.html"><i class="fa fa-check"></i><b>8</b> Advanced Topics</a><ul>
<li class="chapter" data-level="8.1" data-path="advanced.html"><a href="advanced.html#advanced-custom"><i class="fa fa-check"></i><b>8.1</b> Custom downloads</a></li>
<li class="chapter" data-level="8.2" data-path="advanced.html"><a href="advanced.html#advanced-unmarked"><i class="fa fa-check"></i><b>8.2</b> Preparing for occupancy modeling</a></li>
<li class="chapter" data-level="8.3" data-path="advanced.html"><a href="advanced.html#advanced-size"><i class="fa fa-check"></i><b>8.3</b> Reducing file size</a></li>
<li class="chapter" data-level="8.4" data-path="advanced.html"><a href="advanced.html#advanced-modis"><i class="fa fa-check"></i><b>8.4</b> Land cover covariates</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">eBird Best Practices I</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="advanced" class="section level1">
<h1><span class="header-section-number">Lesson 8</span> Advanced Topics</h1>
<div id="advanced-custom" class="section level2">
<h2><span class="header-section-number">8.1</span> Custom downloads</h2>
<p>The full EBD is massive (over 200 GB) and takes a long time to process with <code>auk</code> (typically several hours). In some cases, there is a way around these issues. On the <a href="https://ebird.org/data/download/ebd">EBD download page</a>, there is a Custom Download form that allows you to only download a subset of the EBD for a given species, within a region, and for a range of dates. After submitting this form, the request will be processed on the eBird servers and a email will be sent to you with instructions for downloading the EBD extract.</p>
<p><img src="assets/img/08_advanced_custom.png" /></p>
<p>Recall from the <a href="#presabs--filter">lesson on zero-filling</a>, that we extracted American Flamingo records from Mexico’s Yucatán state in January, and produced presence-absence data from this extract. Let’s try to do this with the Custom Download form. After the request is submitted an email will arrive with instrustions for <a href="https://github.com/mstrimas/ebp-workshop/raw/master/raw-data/ebd_MX-YUC_grefla2_201501_201612_relApr-2019.zip">downloading the following file</a>. Download and unarchive this file, placing the text file in the <code>data/</code> subdirectory of your project.</p>
<pre class="sourceCode r"><code class="sourceCode r">tf &lt;-<span class="st"> &quot;data/temp.zip&quot;</span>
<span class="kw">download.file</span>(<span class="st">&quot;https://github.com/mstrimas/ebp-workshop/raw/master/raw-data/ebd_MX-YUC_grefla2_201501_201612_relApr-2019.zip&quot;</span>, tf)
<span class="kw">unzip</span>(tf, <span class="st">&quot;ebd_MX-YUC_grefla2_201501_201612_relApr-2019.txt&quot;</span>, <span class="dt">exdir =</span> <span class="st">&quot;data/&quot;</span>)
<span class="kw">unlink</span>(tf)</code></pre>
<p>It will quickly become clear that there are two issues with this approach. First, the set of filters available in the Custom Download form is limited. For example, there’s no option to only extract observations from complete checklists or any way to get observations from a given month from any year. To address this, we can apply the additional filters after we’ve imported the data in R. Specifically, we’ll only keep observations from complete checklists in June.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(auk)
<span class="kw">library</span>(lubridate)
<span class="kw">library</span>(tidyverse)

ebd &lt;-<span class="st"> </span><span class="kw">read_ebd</span>(<span class="st">&quot;data/ebd_MX-YUC_grefla2_201501_201612_relApr-2019.txt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">month</span>(observation_date) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, 
         all_species_reported)</code></pre>
<p>The second challenge is that the Custom Download form only provides the positive observations from the EBD, it doesn’t provide the corresponding Sampling Event Data for zero-filling. However, the Sampling Event Data is much smaller than the EBD and quicker to process. So, we can easily filter this file using the same set of filters we’ve already applied to the EBD. Note that <code>auk_sampling()</code> is used in place of <code>auk_ebd()</code> when we’re only filtering the sampling data and not the EBD.</p>
<pre class="sourceCode r"><code class="sourceCode r">f_sed &lt;-<span class="st"> &quot;data/sed-only_amefla.txt&quot;</span>
sed_filt &lt;-<span class="st"> </span><span class="kw">auk_sampling</span>(<span class="st">&quot;ebd_sampling_2015-2016_yucatan.txt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">auk_state</span>(<span class="st">&quot;MX-YUC&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">auk_date</span>(<span class="kw">c</span>(<span class="st">&quot;*-01-01&quot;</span>, <span class="st">&quot;*-01-31&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">auk_complete</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">auk_filter</span>(<span class="st">&quot;data/sed-only_amefla.txt&quot;</span>)
sed &lt;-<span class="st"> </span><span class="kw">read_sampling</span>(f_sed)</code></pre>
<p>Finally, we can join these combine those two dataframes together with <code>auk_zerofill()</code> to produce zero-filled presence-absence data.</p>
<pre class="sourceCode r"><code class="sourceCode r">ebd_zf &lt;-<span class="st"> </span><span class="kw">auk_zerofill</span>(ebd, sed, <span class="dt">collapse =</span> <span class="ot">TRUE</span>)</code></pre>
<p>We’ve produced exactly the same data as in Lesson <a href="presabs.html#presabs">6</a>; however, we’ve done so avoiding having to deal with the full EBD.</p>
</div>
<div id="advanced-unmarked" class="section level2">
<h2><span class="header-section-number">8.2</span> Preparing for occupancy modeling</h2>
<p>One common use of eBird data is for occupancy modeling with the R package <code>unmarked</code>. This workshop won’t cover occupancy modeling; however, <code>unmarked</code> requires data to be formatted in a very particular way and <code>auk</code> contains functions to prepare data in this way, which we’ll cover in this lesson. We’ll continue with the American Flamingo data from the previous section.</p>
<p>First, we need to extract the subset of observations that are suitable for occupancy modeling. In particular, occupancy models typically require data from repeated sampling events to a single site during a time frame over which the population can be considered closed. For example, let’s define the period of closure as the entire month of January in each year and a repeat visit as the same observer revisting a site with same latitude and longitude at least twice. The <code>auk</code> function <code>filter_repeat_visits()</code> is designed to extract a subset of eBird data of this form.</p>
<pre class="sourceCode r"><code class="sourceCode r">visits &lt;-<span class="st"> </span><span class="kw">filter_repeat_visits</span>(ebd_zf, 
                               <span class="dt">min_obs =</span> <span class="dv">2</span>, <span class="dt">max_obs =</span> <span class="dv">10</span>,
                               <span class="dt">annual_closure =</span> <span class="ot">TRUE</span>,
                               <span class="dt">date_var =</span> <span class="st">&quot;observation_date&quot;</span>,
                               <span class="dt">site_vars =</span> <span class="kw">c</span>(<span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>, 
                                             <span class="st">&quot;observer_id&quot;</span>))
<span class="co"># entire data set</span>
<span class="kw">nrow</span>(visits)
<span class="co">#&gt; [1] 112</span>
<span class="co"># reduced data set</span>
<span class="kw">nrow</span>(ebd_zf)
<span class="co">#&gt; [1] 336</span>
<span class="co"># how many individual sites there are</span>
<span class="kw">n_distinct</span>(visits<span class="op">$</span>site)
<span class="co">#&gt; [1] 39</span></code></pre>
<p>Three new columns are added to the dataset when using the function <code>filter_repeat_visits()</code>: <code>site</code> is a unique site ID, <code>closure_id</code> identifies the primary period of closure (in this example the year), and <code>n_observations</code> is the number of visits to each site.</p>
<p>Now that we have data suitable for occupancy modeling, we need to reformat the data to be accepted by <code>unmarked</code>. The documentation for the <code>unmarked</code> function <code>formatWide()</code> outlines the details of this format. In the EBD, each row is a checklist; however, <code>unmarked</code> requires each row to be a site with the first column specifying the site ID and subsequent columns specifying whether the species was observed on each of the visits to that site. The next group of columns contains site-level covariates, those that vary between sites but are constant across visits to the same site, such as latitude, longitude, and habitat covariates. Finally, there are several groups of columns containing observation-level covariates, such as distance and duration. Each covariate gets a set of columns corresponding to the columns specifying the presence-absence of the species.</p>
<p><img src="assets/img/08_advanced_unmarked.png" /></p>
<p>The <code>auk</code> function <code>format_unmarked_occu()</code> takes care of the reformatting for you. <code>response</code> is the variable that you will be using as the response in occupancy modeling (e.g. <code>observation_count</code> or <code>species_observered</code>), <code>site_covs</code> are the site-level covariates, and <code>obs_covs</code> are the observation-level covariates.</p>
<pre class="sourceCode r"><code class="sourceCode r">visits_um &lt;-<span class="st"> </span><span class="kw">format_unmarked_occu</span>(visits, 
                                  <span class="dt">site_id =</span> <span class="st">&quot;site&quot;</span>, 
                                  <span class="dt">response =</span> <span class="st">&quot;species_observed&quot;</span>,
                                  <span class="dt">site_covs =</span> <span class="kw">c</span>(<span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>),
                                  <span class="dt">obs_covs =</span> <span class="kw">c</span>(<span class="st">&quot;time_observations_started&quot;</span>, 
                                               <span class="st">&quot;duration_minutes&quot;</span>, 
                                               <span class="st">&quot;effort_distance_km&quot;</span>, 
                                               <span class="st">&quot;number_observers&quot;</span>, 
                                               <span class="st">&quot;protocol_type&quot;</span>))</code></pre>
<div class="exercise">
<h2>
Exercise
</h2>
<p>Explore both the <code>visits_um</code> and <code>visits</code> dataframes. They contain the same data in different formats. Try to understand how one dataframe was transformed into the other.</p>
</div>
</div>
<div id="advanced-size" class="section level2">
<h2><span class="header-section-number">8.3</span> Reducing file size</h2>
</div>
<div id="advanced-modis" class="section level2">
<h2><span class="header-section-number">8.4</span> Land cover covariates</h2>

</div>
</div>
<script>
var coll = document.getElementsByClassName("solution");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}
</script>
            </section>

          </div>
        </div>
      </div>
<a href="applications.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mstrimas/ebp-workshop/edit/master/08_advanced.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
