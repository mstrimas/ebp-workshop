<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Lesson 11 Occupancy | eBird Best Practices Workshop</title>
  <meta name="description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Lesson 11 Occupancy | eBird Best Practices Workshop" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Best practices for using eBird data to estimate species distributions" />
  <meta name="github-repo" content="mstrimas/ebp-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Lesson 11 Occupancy | eBird Best Practices Workshop" />
  
  <meta name="twitter:description" content="Best practices for using eBird data to estimate species distributions" />
  

<meta name="author" content="Matthew Strimas-Mackey, Alison Johnston, Wesley M. Hochachka, Viviana Ruiz-Gutierrez, Orin J. Robinson, Eliot T. Miller, Tom Auer, Steve Kelling, Daniel Fink" />


<meta name="date" content="2020-01-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="encounter.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="assets/css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">eBird Best Practices Workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#intro-data"><i class="fa fa-check"></i><b>1.1</b> Data</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#intro-format"><i class="fa fa-check"></i><b>1.2</b> Format</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#intro-setup"><i class="fa fa-check"></i><b>1.3</b> Setup</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#intro-tidyverse"><i class="fa fa-check"></i><b>1.4</b> Tidyverse</a></li>
</ul></li>
<li class="part"><span><b>I eBird Data</b></span></li>
<li class="chapter" data-level="2" data-path="ebird-intro.html"><a href="ebird-intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="ebird-intro.html"><a href="ebird-intro.html#the-auk-workflow"><i class="fa fa-check"></i><b>2.1</b> The <code>auk</code> workflow</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="access.html"><a href="access.html"><i class="fa fa-check"></i><b>3</b> Data Access</a></li>
<li class="chapter" data-level="4" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>4</b> Filtering</a><ul>
<li class="chapter" data-level="4.1" data-path="filter.html"><a href="filter.html#filter-define"><i class="fa fa-check"></i><b>4.1</b> Defining filters</a><ul>
<li class="chapter" data-level="4.1.1" data-path="filter.html"><a href="filter.html#filter-define-complete"><i class="fa fa-check"></i><b>4.1.1</b> Complete checklists</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="filter.html"><a href="filter.html#filter-execute"><i class="fa fa-check"></i><b>4.2</b> Execute filters</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="import.html"><a href="import.html"><i class="fa fa-check"></i><b>5</b> Importing Data</a><ul>
<li class="chapter" data-level="5.1" data-path="import.html"><a href="import.html#import-group"><i class="fa fa-check"></i><b>5.1</b> Group checklists</a></li>
<li class="chapter" data-level="5.2" data-path="import.html"><a href="import.html#import-taxonomy"><i class="fa fa-check"></i><b>5.2</b> Taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="presabs.html"><a href="presabs.html"><i class="fa fa-check"></i><b>6</b> Presence-absence Data</a><ul>
<li class="chapter" data-level="6.1" data-path="presabs.html"><a href="presabs.html#presabs-filter"><i class="fa fa-check"></i><b>6.1</b> Filtering</a></li>
<li class="chapter" data-level="6.2" data-path="presabs.html"><a href="presabs.html#presabs-zerofill"><i class="fa fa-check"></i><b>6.2</b> Zero-filling</a></li>
<li class="chapter" data-level="6.3" data-path="presabs.html"><a href="presabs.html#presabs-tidy"><i class="fa fa-check"></i><b>6.3</b> Tidying up</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="subsampling.html"><a href="subsampling.html"><i class="fa fa-check"></i><b>7</b> Spatiotemporal Subsampling</a><ul>
<li class="chapter" data-level="7.1" data-path="subsampling.html"><a href="subsampling.html#subsampling-toy"><i class="fa fa-check"></i><b>7.1</b> A toy example</a></li>
<li class="chapter" data-level="7.2" data-path="subsampling.html"><a href="subsampling.html#subsampling-ebird"><i class="fa fa-check"></i><b>7.2</b> Subsampling eBird data</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="applications.html"><a href="applications.html"><i class="fa fa-check"></i><b>8</b> Applications</a><ul>
<li class="chapter" data-level="8.1" data-path="applications.html"><a href="applications.html#applications-trajectory"><i class="fa fa-check"></i><b>8.1</b> Frequency trajectories</a></li>
<li class="chapter" data-level="8.2" data-path="applications.html"><a href="applications.html#applications-maps"><i class="fa fa-check"></i><b>8.2</b> Maps</a></li>
</ul></li>
<li class="part"><span><b>II Distribution Modeling</b></span></li>
<li class="chapter" data-level="9" data-path="model-intro.html"><a href="model-intro.html"><i class="fa fa-check"></i><b>9</b> Introduction</a><ul>
<li class="chapter" data-level="9.1" data-path="model-intro.html"><a href="model-intro.html#model-intro-data"><i class="fa fa-check"></i><b>9.1</b> Example data</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="encounter.html"><a href="encounter.html"><i class="fa fa-check"></i><b>10</b> Encounter Rate</a><ul>
<li class="chapter" data-level="10.1" data-path="encounter.html"><a href="encounter.html#encounter-prep"><i class="fa fa-check"></i><b>10.1</b> Data preparation</a></li>
<li class="chapter" data-level="10.2" data-path="encounter.html"><a href="encounter.html#encounter-rf"><i class="fa fa-check"></i><b>10.2</b> Random forests</a><ul>
<li class="chapter" data-level="10.2.1" data-path="encounter.html"><a href="encounter.html#encounter-rf-assess"><i class="fa fa-check"></i><b>10.2.1</b> Model assessment</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="encounter.html"><a href="encounter.html#encounter-habitat"><i class="fa fa-check"></i><b>10.3</b> Habitat associations</a><ul>
<li class="chapter" data-level="10.3.1" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pi"><i class="fa fa-check"></i><b>10.3.1</b> Predictor importance</a></li>
<li class="chapter" data-level="10.3.2" data-path="encounter.html"><a href="encounter.html#encounter-habitat-pd"><i class="fa fa-check"></i><b>10.3.2</b> Partial dependence</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="encounter.html"><a href="encounter.html#encounter-predict"><i class="fa fa-check"></i><b>10.4</b> Prediction</a></li>
<li class="chapter" data-level="10.5" data-path="encounter.html"><a href="encounter.html#encouter-exercises"><i class="fa fa-check"></i><b>10.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="occupancy.html"><a href="occupancy.html"><i class="fa fa-check"></i><b>11</b> Occupancy</a><ul>
<li class="chapter" data-level="11.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-prep"><i class="fa fa-check"></i><b>11.1</b> Data preparation</a></li>
<li class="chapter" data-level="11.2" data-path="occupancy.html"><a href="occupancy.html#occupancy-model"><i class="fa fa-check"></i><b>11.2</b> Occupancy modeling</a><ul>
<li class="chapter" data-level="11.2.1" data-path="occupancy.html"><a href="occupancy.html#occupancy-model-assess"><i class="fa fa-check"></i><b>11.2.1</b> Assessment</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="occupancy.html"><a href="occupancy.html#occupancy-predict"><i class="fa fa-check"></i><b>11.3</b> Prediction</a></li>
<li class="chapter" data-level="11.4" data-path="occupancy.html"><a href="occupancy.html#occupancy-exercises"><i class="fa fa-check"></i><b>11.4</b> Exercises</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">eBird Best Practices Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="occupancy" class="section level1">
<h1><span class="header-section-number">Lesson 11</span> Occupancy</h1>
<p>In this lesson, we’ll use occupancy models to estimate the occupancy of Wood Thrush on eBird checklists in June in BCR 27, while explicitly accounting for imperfect detection. First, we’ll give a short presentation introducing occupancy modeling. The presentation can be downloaded in <a href="https://github.com/mstrimas/ebp-workshop/raw/master/12_occupancy.pptx">PowerPoint</a> or <a href="https://github.com/mstrimas/ebp-workshop/raw/master/12_occupancy.pdf">PDF</a> format, or <a href="https://speakerdeck.com/mstrimas/ebird-best-practices-ii-occupancy">viewed on SpeakerDeck</a>.</p>
<iframe src="https://speakerdeck.com/player/7375bae455c04703a770c0c6ab26dc6a" width="700px" height="400px" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:none;" allowfullscreen webkitallowfullscreen mozallowfullscreen>
</iframe>
<p>Let’s start by loading the packages and data required for this lesson.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="kw">library</span>(auk)</a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb71-3" data-line-number="3"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb71-4" data-line-number="4"><span class="kw">library</span>(dggridR)</a>
<a class="sourceLine" id="cb71-5" data-line-number="5"><span class="kw">library</span>(unmarked)</a>
<a class="sourceLine" id="cb71-6" data-line-number="6"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb71-7" data-line-number="7"><span class="kw">library</span>(ebirdst)</a>
<a class="sourceLine" id="cb71-8" data-line-number="8"><span class="kw">library</span>(MuMIn)</a>
<a class="sourceLine" id="cb71-9" data-line-number="9"><span class="kw">library</span>(AICcmodavg)</a>
<a class="sourceLine" id="cb71-10" data-line-number="10"><span class="kw">library</span>(fields)</a>
<a class="sourceLine" id="cb71-11" data-line-number="11"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb71-12" data-line-number="12"><span class="co"># resolve namespace conflicts</span></a>
<a class="sourceLine" id="cb71-13" data-line-number="13">select &lt;-<span class="st"> </span>dplyr<span class="op">::</span>select</a>
<a class="sourceLine" id="cb71-14" data-line-number="14">projection &lt;-<span class="st"> </span>raster<span class="op">::</span>projection</a>
<a class="sourceLine" id="cb71-15" data-line-number="15"></a>
<a class="sourceLine" id="cb71-16" data-line-number="16"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb71-17" data-line-number="17"></a>
<a class="sourceLine" id="cb71-18" data-line-number="18"><span class="co"># ebird data</span></a>
<a class="sourceLine" id="cb71-19" data-line-number="19">ebird &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/ebd_woothr_june_bcr27_zf.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">year</span>(observation_date),</a>
<a class="sourceLine" id="cb71-21" data-line-number="21">         <span class="co"># occupancy modeling requires an integer response</span></a>
<a class="sourceLine" id="cb71-22" data-line-number="22">         <span class="dt">species_observed =</span> <span class="kw">as.integer</span>(species_observed))</a>
<a class="sourceLine" id="cb71-23" data-line-number="23"></a>
<a class="sourceLine" id="cb71-24" data-line-number="24"><span class="co"># modis land cover covariates</span></a>
<a class="sourceLine" id="cb71-25" data-line-number="25">habitat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/pland-elev_location-year.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-26" data-line-number="26"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.integer</span>(year))</a>
<a class="sourceLine" id="cb71-27" data-line-number="27"></a>
<a class="sourceLine" id="cb71-28" data-line-number="28"><span class="co"># combine ebird and modis data</span></a>
<a class="sourceLine" id="cb71-29" data-line-number="29">ebird_habitat &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ebird, habitat, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;year&quot;</span>))</a>
<a class="sourceLine" id="cb71-30" data-line-number="30"></a>
<a class="sourceLine" id="cb71-31" data-line-number="31"><span class="co"># prediction surface</span></a>
<a class="sourceLine" id="cb71-32" data-line-number="32">pred_surface &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/pland-elev_prediction-surface.csv&quot;</span>)</a>
<a class="sourceLine" id="cb71-33" data-line-number="33"><span class="co"># latest year of landcover data</span></a>
<a class="sourceLine" id="cb71-34" data-line-number="34">max_lc_year &lt;-<span class="st"> </span>pred_surface<span class="op">$</span>year[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb71-35" data-line-number="35">r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;data/prediction-surface.tif&quot;</span>)</a>
<a class="sourceLine" id="cb71-36" data-line-number="36"></a>
<a class="sourceLine" id="cb71-37" data-line-number="37"><span class="co"># load gis data for making maps</span></a>
<a class="sourceLine" id="cb71-38" data-line-number="38">map_proj &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">102003</span>)</a>
<a class="sourceLine" id="cb71-39" data-line-number="39">ne_land &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_land&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-40" data-line-number="40"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-41" data-line-number="41"><span class="st">  </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb71-42" data-line-number="42">bcr &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;bcr&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-43" data-line-number="43"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-44" data-line-number="44"><span class="st">  </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb71-45" data-line-number="45">ne_country_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_country_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-46" data-line-number="46"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-47" data-line-number="47"><span class="st">  </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb71-48" data-line-number="48">ne_state_lines &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/gis-data.gpkg&quot;</span>, <span class="st">&quot;ne_state_lines&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-49" data-line-number="49"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> map_proj) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-50" data-line-number="50"><span class="st">  </span><span class="kw">st_geometry</span>()</a></code></pre></div>
<div id="occupancy-prep" class="section level2">
<h2><span class="header-section-number">11.1</span> Data preparation</h2>
<p>Since we’ll be fitting a single-season occupancy models, we’ll need to start by focusing on observations from June of a single year, in this case the most recent year for which we have data. At this point, we also suggest subsetting the data to observations with 5 or fewer observers since there are few checklists with more than 5 observers.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="co"># filter to a single year of data</span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2">ebird_filtered &lt;-<span class="st"> </span><span class="kw">filter</span>(ebird_habitat, </a>
<a class="sourceLine" id="cb72-3" data-line-number="3">                         number_observers <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb72-4" data-line-number="4">                         year <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(year))</a></code></pre></div>
<p>Next, we need to extract a subset of observations that are suitable for occupancy modeling. In particular, occupancy models typically require data from repeated visits to a single site during a time frame over which the population can be considered closed. The <code>auk</code> function <code>filter_repeat_visits()</code> is designed to extract subsets of eBird data that meet these criteria. Specifically, we want repeat visits to the same location by the same observer, so we’ll use latitude, longitude, and observer ID to define ‘sites’. We’ll take the month of June as our period of closure.The relevant parameters in <code>filter_repeat_visits</code> are:</p>
<ul>
<li><code>min_obs</code> and <code>max_obs</code>: the minimum and maximum number of repeat visits to a given site. Occupancy modeling requires at least two visits to each site.</li>
<li><code>date_var</code>: the column name of the date variable used to define the period of closure.</li>
<li><code>annual_closure</code>: define the period of closure as the entire year. This works here because we’ve already subset the data to only keep observations from January, which results in the period of closure being the month of January in given year. The <code>n_days</code> argument can be used to define the period of closure more flexibly.</li>
<li><code>site_vars</code>: a character vector of names of columns that define a site. This is typically the combination of variables defining the location (<code>locality_id</code> or <code>latitude</code>/<code>longitude</code>) and observer (<code>observer_id</code>).</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="sourceCode r livecode"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="co"># subset for occupancy modeling</span></a>
<a class="sourceLine" id="cb73-2" data-line-number="2">occ &lt;-<span class="st"> </span><span class="kw">filter_repeat_visits</span>(ebird_filtered, </a>
<a class="sourceLine" id="cb73-3" data-line-number="3">                            <span class="dt">min_obs =</span> <span class="dv">2</span>, <span class="dt">max_obs =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb73-4" data-line-number="4">                            <span class="dt">annual_closure =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb73-5" data-line-number="5">                            <span class="dt">date_var =</span> <span class="st">&quot;observation_date&quot;</span>,</a>
<a class="sourceLine" id="cb73-6" data-line-number="6">                            <span class="dt">site_vars =</span> <span class="kw">c</span>(<span class="st">&quot;locality_id&quot;</span>, <span class="st">&quot;observer_id&quot;</span>))</a></code></pre></div>
<p>Three new columns are added to the dataset when using the function <code>filter_repeat_visits()</code>: <code>site</code> is a unique site ID, <code>closure_id</code> identifies the primary period of closure (in this example the year), and <code>n_observations</code> is the number of visits to each site.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="kw">select</span>(occ, site, closure_id, n_observations)</a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="co">#&gt; # A tibble: 3,656 x 3</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="co">#&gt;   site                    closure_id n_observations</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="co">#&gt;   &lt;chr&gt;                   &lt;chr&gt;               &lt;int&gt;</span></a>
<a class="sourceLine" id="cb74-5" data-line-number="5"><span class="co">#&gt; 1 L1005433_obs119886_2019 2019                    3</span></a>
<a class="sourceLine" id="cb74-6" data-line-number="6"><span class="co">#&gt; 2 L1005433_obs119886_2019 2019                    3</span></a>
<a class="sourceLine" id="cb74-7" data-line-number="7"><span class="co">#&gt; 3 L1005433_obs119886_2019 2019                    3</span></a>
<a class="sourceLine" id="cb74-8" data-line-number="8"><span class="co">#&gt; 4 L1007991_obs132896_2019 2019                    2</span></a>
<a class="sourceLine" id="cb74-9" data-line-number="9"><span class="co">#&gt; 5 L1007991_obs132896_2019 2019                    2</span></a>
<a class="sourceLine" id="cb74-10" data-line-number="10"><span class="co">#&gt; 6 L1007991_obs970026_2019 2019                    3</span></a>
<a class="sourceLine" id="cb74-11" data-line-number="11"><span class="co">#&gt; # … with 3,650 more rows</span></a></code></pre></div>
<div class="exercise">
<h2>
Exercise
</h2>
<p>Suppose you define the temporal period of closure as week long blocks, rather than the whole month of June. Use <code>filter_repeat_visits()</code> to extract eBird data accordingly. Consult the documentation for this function for help.</p>
<button class="solution">Solution</button>
<div class="solution-content">
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">occ_days &lt;-<span class="st"> </span><span class="kw">filter_repeat_visits</span>(ebird_filtered, </a>
<a class="sourceLine" id="cb75-2" data-line-number="2">                                 <span class="dt">min_obs =</span> <span class="dv">2</span>, <span class="dt">max_obs =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">                                 <span class="dt">n_days =</span> <span class="dv">7</span>,</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">                                 <span class="dt">date_var =</span> <span class="st">&quot;observation_date&quot;</span>,</a>
<a class="sourceLine" id="cb75-5" data-line-number="5">                                 <span class="dt">site_vars =</span> <span class="kw">c</span>(<span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>, </a>
<a class="sourceLine" id="cb75-6" data-line-number="6">                                               <span class="st">&quot;observer_id&quot;</span>))</a></code></pre></div>
</div>
</div>
<div class="exercise">
<h2>
Exercise
</h2>
<p>Subsetting eBird data to just the observations suitable for occupancy modeling will inevitably reduce the amount of data. What proportion of observations remain after calling <code>filter_repeat_visits()</code>? How many unique sites do we have?</p>
<button class="solution">Solution</button>
<div class="solution-content">
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1"><span class="kw">nrow</span>(occ) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(ebird_habitat)</a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="co">#&gt; [1] 0.0768</span></a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="kw">n_distinct</span>(occ<span class="op">$</span>site)</a>
<a class="sourceLine" id="cb76-4" data-line-number="4"><span class="co">#&gt; [1] 966</span></a></code></pre></div>
</div>
</div>
<p>Now that we have data suitable for occupancy modeling, we need to reformat the data to be accepted by <code>unmarked</code>. The documentation for the <code>unmarked</code> function <code>formatWide()</code> outlines the details of this format. In the EBD, each row is a checklist; however, <code>unmarked</code> requires each row to be a site with the first column specifying the site ID and subsequent columns specifying whether the species was observed on each of the visits to that site. The next group of columns contains site-level covariates, those that vary between sites but are constant across visits to the same site, such as latitude, longitude, and any habitat covariates we might have. Finally, the observation-level covariates, such as distance and duration, each get a set of columns corresponding to the the presence-absence columns. Here’s a simple example with some made up data to illustrate the format:</p>
<div style="border: 0; padding: 0; overflow-x: scroll; width:100%; ">
<table class="table table-striped table-responsive" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
site_id
</th>
<th style="text-align:left;">
y.1
</th>
<th style="text-align:left;">
y.2
</th>
<th style="text-align:left;">
y.3
</th>
<th style="text-align:right;">
latitude
</th>
<th style="text-align:right;">
longitude
</th>
<th style="text-align:right;">
forest_cover
</th>
<th style="text-align:right;">
distance.1
</th>
<th style="text-align:right;">
distance.2
</th>
<th style="text-align:right;">
distance.3
</th>
<th style="text-align:right;">
time.1
</th>
<th style="text-align:right;">
time.2
</th>
<th style="text-align:right;">
time.3
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
site1
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
20.2
</td>
<td style="text-align:right;">
182
</td>
<td style="text-align:right;">
0.12
</td>
<td style="text-align:right;">
14.51
</td>
<td style="text-align:right;">
10.01
</td>
<td style="text-align:right;">
12.41
</td>
<td style="text-align:right;">
33.7
</td>
<td style="text-align:right;">
43.5
</td>
<td style="text-align:right;">
20.7
</td>
</tr>
<tr>
<td style="text-align:left;">
site2
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
20.6
</td>
<td style="text-align:right;">
183
</td>
<td style="text-align:right;">
0.45
</td>
<td style="text-align:right;">
9.84
</td>
<td style="text-align:right;">
11.90
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
26.4
</td>
<td style="text-align:right;">
23.8
</td>
<td style="text-align:right;">
</td>
</tr>
<tr>
<td style="text-align:left;">
site3
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
19.9
</td>
<td style="text-align:right;">
182
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
8.95
</td>
<td style="text-align:right;">
12.63
</td>
<td style="text-align:right;">
9.78
</td>
<td style="text-align:right;">
23.4
</td>
<td style="text-align:right;">
30.1
</td>
<td style="text-align:right;">
13.3
</td>
</tr>
<tr>
<td style="text-align:left;">
site4
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
</td>
<td style="text-align:right;">
21.0
</td>
<td style="text-align:right;">
183
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
10.26
</td>
<td style="text-align:right;">
6.00
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
31.9
</td>
<td style="text-align:right;">
26.9
</td>
<td style="text-align:right;">
</td>
</tr>
<tr>
<td style="text-align:left;">
site5
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
29.8
</td>
<td style="text-align:right;">
183
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
11.34
</td>
<td style="text-align:right;">
7.58
</td>
<td style="text-align:right;">
16.88
</td>
<td style="text-align:right;">
24.8
</td>
<td style="text-align:right;">
25.0
</td>
<td style="text-align:right;">
23.6
</td>
</tr>
</tbody>
</table>
</div>
<p>The <code>auk</code> function <code>format_unmarked_occu()</code> takes care of the reformatting for you. In this function, <code>site_covs</code> are the names of the site-level covariates and <code>obs_covs</code> are the names of the observation-level covariates. Prior knowledge of Wood Thrush, as well as the predictor importance results from the <a href="encounter.html#encounter-habitat">encounter rate</a> lesson, inform what land cover variables we choose as occupancy covariates. The five effort variables should always be included as detection covariates, but we’ll also examine whether different habitat types affect the detection probability.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r livecode"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="co"># format for unmarked, select occupancy and detection covariates</span></a>
<a class="sourceLine" id="cb77-2" data-line-number="2">occ_wide &lt;-<span class="st"> </span><span class="kw">format_unmarked_occu</span>(occ, </a>
<a class="sourceLine" id="cb77-3" data-line-number="3">                                 <span class="dt">site_id =</span> <span class="st">&quot;site&quot;</span>, </a>
<a class="sourceLine" id="cb77-4" data-line-number="4">                                 <span class="dt">response =</span> <span class="st">&quot;species_observed&quot;</span>,</a>
<a class="sourceLine" id="cb77-5" data-line-number="5">                                 <span class="dt">site_covs =</span> <span class="kw">c</span>(<span class="st">&quot;latitude&quot;</span>, <span class="st">&quot;longitude&quot;</span>, </a>
<a class="sourceLine" id="cb77-6" data-line-number="6">                                               <span class="co"># % deciduous forest</span></a>
<a class="sourceLine" id="cb77-7" data-line-number="7">                                               <span class="st">&quot;pland_04&quot;</span>, </a>
<a class="sourceLine" id="cb77-8" data-line-number="8">                                               <span class="co"># % mixed forest</span></a>
<a class="sourceLine" id="cb77-9" data-line-number="9">                                               <span class="st">&quot;pland_05&quot;</span>,</a>
<a class="sourceLine" id="cb77-10" data-line-number="10">                                               <span class="co"># % cropland</span></a>
<a class="sourceLine" id="cb77-11" data-line-number="11">                                               <span class="st">&quot;pland_12&quot;</span>,</a>
<a class="sourceLine" id="cb77-12" data-line-number="12">                                               <span class="co"># % urban</span></a>
<a class="sourceLine" id="cb77-13" data-line-number="13">                                               <span class="st">&quot;pland_13&quot;</span>),</a>
<a class="sourceLine" id="cb77-14" data-line-number="14">                                 <span class="dt">obs_covs =</span> <span class="kw">c</span>(<span class="st">&quot;time_observations_started&quot;</span>, </a>
<a class="sourceLine" id="cb77-15" data-line-number="15">                                              <span class="st">&quot;duration_minutes&quot;</span>, </a>
<a class="sourceLine" id="cb77-16" data-line-number="16">                                              <span class="st">&quot;effort_distance_km&quot;</span>, </a>
<a class="sourceLine" id="cb77-17" data-line-number="17">                                              <span class="st">&quot;number_observers&quot;</span>, </a>
<a class="sourceLine" id="cb77-18" data-line-number="18">                                              <span class="st">&quot;protocol_type&quot;</span>,</a>
<a class="sourceLine" id="cb77-19" data-line-number="19">                                              <span class="st">&quot;pland_04&quot;</span>, </a>
<a class="sourceLine" id="cb77-20" data-line-number="20">                                              <span class="st">&quot;pland_05&quot;</span>))</a></code></pre></div>
<div class="exercise">
<h2>
Exercise
</h2>
<p>Explore both the <code>occ_wide</code> and <code>occ</code> data frames. They contain the same data in different formats. Try to understand how one data frame was transformed into the other.</p>
</div>
<p>As described in lesson <a href="subsampling.html#subsampling">7</a>, we’ll use spatial subsampling to reduce spatial bias. However, here we’ll subsample at the level of ‘sites’ rather than observations.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="co"># generate hexagonal grid with ~ 5 km betweeen cells</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2">dggs &lt;-<span class="st"> </span><span class="kw">dgconstruct</span>(<span class="dt">spacing =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb78-3" data-line-number="3"><span class="co"># get hexagonal cell id for each site</span></a>
<a class="sourceLine" id="cb78-4" data-line-number="4">occ_wide_cell &lt;-<span class="st"> </span>occ_wide <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cell =</span> <span class="kw">dgGEO_to_SEQNUM</span>(dggs, longitude, latitude)<span class="op">$</span>seqnum)</a>
<a class="sourceLine" id="cb78-6" data-line-number="6"><span class="co"># sample one checklist per grid cell</span></a>
<a class="sourceLine" id="cb78-7" data-line-number="7">occ_ss &lt;-<span class="st"> </span>occ_wide_cell <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(cell) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-9" data-line-number="9"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-10" data-line-number="10"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>cell)</a></code></pre></div>
<p>Finally, we’ll convert this data frame of observations into an <code>unmarked</code> object in order to fit occupancy models.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r livecode"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1"><span class="co"># creat unmarked object</span></a>
<a class="sourceLine" id="cb79-2" data-line-number="2">occ_um &lt;-<span class="st"> </span><span class="kw">formatWide</span>(occ_ss, <span class="dt">type =</span> <span class="st">&quot;unmarkedFrameOccu&quot;</span>)</a></code></pre></div>
</div>
<div id="occupancy-model" class="section level2">
<h2><span class="header-section-number">11.2</span> Occupancy modeling</h2>
<p>Now that the data are prepared, we can fit a single-season occupancy model to using the <code>occu()</code> function, specifying the detection and occupancy covariates, respectively, via a double right-hand sided formula of the form <code>~ detection covariates ~ occupancy covariates</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r livecode"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co"># fit model</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2">occ_model &lt;-<span class="st"> </span><span class="kw">occu</span>(<span class="op">~</span><span class="st"> </span>time_observations_started <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-3" data-line-number="3"><span class="st">                    </span>duration_minutes <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-4" data-line-number="4"><span class="st">                    </span>effort_distance_km <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-5" data-line-number="5"><span class="st">                    </span>number_observers <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-6" data-line-number="6"><span class="st">                    </span>protocol_type <span class="op">+</span></a>
<a class="sourceLine" id="cb80-7" data-line-number="7"><span class="st">                    </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span></a>
<a class="sourceLine" id="cb80-8" data-line-number="8">                  <span class="op">~</span><span class="st"> </span>pland_<span class="dv">04</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">05</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>pland_<span class="dv">13</span>, </a>
<a class="sourceLine" id="cb80-9" data-line-number="9">                  <span class="dt">data =</span> occ_um)</a>
<a class="sourceLine" id="cb80-10" data-line-number="10"><span class="co"># look at the regression coefficients from the model</span></a>
<a class="sourceLine" id="cb80-11" data-line-number="11"><span class="kw">summary</span>(occ_model)</a>
<a class="sourceLine" id="cb80-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb80-13" data-line-number="13"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb80-14" data-line-number="14"><span class="co">#&gt; occu(formula = ~time_observations_started + duration_minutes + </span></a>
<a class="sourceLine" id="cb80-15" data-line-number="15"><span class="co">#&gt;     effort_distance_km + number_observers + protocol_type + pland_04 + </span></a>
<a class="sourceLine" id="cb80-16" data-line-number="16"><span class="co">#&gt;     pland_05 ~ pland_04 + pland_05 + pland_12 + pland_13, data = occ_um)</span></a>
<a class="sourceLine" id="cb80-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb80-18" data-line-number="18"><span class="co">#&gt; Occupancy (logit-scale):</span></a>
<a class="sourceLine" id="cb80-19" data-line-number="19"><span class="co">#&gt;             Estimate    SE     z  P(&gt;|z|)</span></a>
<a class="sourceLine" id="cb80-20" data-line-number="20"><span class="co">#&gt; (Intercept)   -1.930 0.239 -8.09 5.98e-16</span></a>
<a class="sourceLine" id="cb80-21" data-line-number="21"><span class="co">#&gt; pland_04       7.698 2.342  3.29 1.01e-03</span></a>
<a class="sourceLine" id="cb80-22" data-line-number="22"><span class="co">#&gt; pland_05       0.925 0.793  1.17 2.43e-01</span></a>
<a class="sourceLine" id="cb80-23" data-line-number="23"><span class="co">#&gt; pland_12      -1.088 1.907 -0.57 5.68e-01</span></a>
<a class="sourceLine" id="cb80-24" data-line-number="24"><span class="co">#&gt; pland_13      -2.179 1.006 -2.17 3.02e-02</span></a>
<a class="sourceLine" id="cb80-25" data-line-number="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb80-26" data-line-number="26"><span class="co">#&gt; Detection (logit-scale):</span></a>
<a class="sourceLine" id="cb80-27" data-line-number="27"><span class="co">#&gt;                           Estimate      SE      z P(&gt;|z|)</span></a>
<a class="sourceLine" id="cb80-28" data-line-number="28"><span class="co">#&gt; (Intercept)               -1.48021 0.60437 -2.449 0.01432</span></a>
<a class="sourceLine" id="cb80-29" data-line-number="29"><span class="co">#&gt; time_observations_started -0.03619 0.02915 -1.242 0.21437</span></a>
<a class="sourceLine" id="cb80-30" data-line-number="30"><span class="co">#&gt; duration_minutes           0.00113 0.00339  0.332 0.73982</span></a>
<a class="sourceLine" id="cb80-31" data-line-number="31"><span class="co">#&gt; effort_distance_km         0.07467 0.15358  0.486 0.62684</span></a>
<a class="sourceLine" id="cb80-32" data-line-number="32"><span class="co">#&gt; number_observers           0.48063 0.33169  1.449 0.14733</span></a>
<a class="sourceLine" id="cb80-33" data-line-number="33"><span class="co">#&gt; protocol_typeTraveling     0.88882 0.37258  2.386 0.01705</span></a>
<a class="sourceLine" id="cb80-34" data-line-number="34"><span class="co">#&gt; pland_04                  -0.73640 0.53583 -1.374 0.16934</span></a>
<a class="sourceLine" id="cb80-35" data-line-number="35"><span class="co">#&gt; pland_05                   3.25239 1.06567  3.052 0.00227</span></a>
<a class="sourceLine" id="cb80-36" data-line-number="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb80-37" data-line-number="37"><span class="co">#&gt; AIC: 690 </span></a>
<a class="sourceLine" id="cb80-38" data-line-number="38"><span class="co">#&gt; Number of sites: 575</span></a>
<a class="sourceLine" id="cb80-39" data-line-number="39"><span class="co">#&gt; optim convergence code: 0</span></a>
<a class="sourceLine" id="cb80-40" data-line-number="40"><span class="co">#&gt; optim iterations: 61 </span></a>
<a class="sourceLine" id="cb80-41" data-line-number="41"><span class="co">#&gt; Bootstrap iterations: 0</span></a></code></pre></div>
<div id="occupancy-model-assess" class="section level3">
<h3><span class="header-section-number">11.2.1</span> Assessment</h3>
<p>The MacKenzie and Bailey <span class="citation">[-@mackenzieAssessingFitSiteoccupancy2004]</span> goodness-of-fit test can be used to assess the occupancy model fit. Note that to produce accurate results, this process requires simulating about 1,000 bootstrap samples, which can take a long time to run. For the sake of speed, if you want to run the below code, we suggest using <code>nsim = 5</code>.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r dontrun"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">occ_gof &lt;-<span class="st"> </span><span class="kw">mb.gof.test</span>(occ_model, <span class="dt">nsim =</span> <span class="dv">1000</span>, <span class="dt">plot.hist =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb81-2" data-line-number="2"><span class="kw">print</span>(occ_gof)</a></code></pre></div>
<pre><code>#&gt; 
#&gt; MacKenzie and Bailey goodness-of-fit for single-season occupancy model
#&gt; 
#&gt; Chi-square statistic = 1630 
#&gt; Number of bootstrap samples = 1000
#&gt; P-value = 0.593
#&gt; 
#&gt; Quantiles of bootstrapped statistics:
#&gt;    0%   25%   50%   75%  100% 
#&gt;   571  1385  1755  2195 14050 
#&gt; 
#&gt; Estimate of c-hat = 0.83</code></pre>
</div>
</div>
<div id="occupancy-predict" class="section level2">
<h2><span class="header-section-number">11.3</span> Prediction</h2>
<p>Now we can estimate the distribution of Wood Thrush in BCR 27 and produce a map. Recall that when we <a href="encounter.html#encounter-predict">predicted encouter rate</a>, we had to include effort variables in our prediction surface. We don’t need to do that here because the estimated occupancy doesn’t depend on the effort covariates, these only occur in the detection submodel. In addition, <code>predict()</code> can produce both predictions as well as estimates of the standard error.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r livecode"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="co"># make prediction for bcr 27</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2">occ_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(occ_model, </a>
<a class="sourceLine" id="cb83-3" data-line-number="3">                    <span class="dt">newdata =</span> <span class="kw">as.data.frame</span>(pred_surface), </a>
<a class="sourceLine" id="cb83-4" data-line-number="4">                    <span class="dt">type =</span> <span class="st">&quot;state&quot;</span>)</a>
<a class="sourceLine" id="cb83-5" data-line-number="5"></a>
<a class="sourceLine" id="cb83-6" data-line-number="6"><span class="co"># add to prediction surface</span></a>
<a class="sourceLine" id="cb83-7" data-line-number="7">pred_occ &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(pred_surface, </a>
<a class="sourceLine" id="cb83-8" data-line-number="8">                      <span class="dt">occ_prob =</span> occ_pred<span class="op">$</span>Predicted, </a>
<a class="sourceLine" id="cb83-9" data-line-number="9">                      <span class="dt">occ_se =</span> occ_pred<span class="op">$</span>SE) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb83-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(latitude, longitude, occ_prob, occ_se)</a></code></pre></div>
<div class="checkpoint">
<h2>
Checkpoint
</h2>
<p>Predicting on the full prediction surface will typically take several minutes. As the above code runs, let’s take a short break.</p>
</div>
<p>Next, we want to plot these predictions. We’ll convert this data frame to spatial features using <code>sf</code>, then rasterize the points using the prediction surface raster template.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">r_pred &lt;-<span class="st"> </span>pred_occ <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="st">  </span><span class="co"># convert to spatial features</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(r)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="st">  </span><span class="co"># rasterize</span></a>
<a class="sourceLine" id="cb84-6" data-line-number="6"><span class="st">  </span><span class="kw">rasterize</span>(r)</a>
<a class="sourceLine" id="cb84-7" data-line-number="7">r_pred &lt;-<span class="st"> </span>r_pred[[<span class="kw">c</span>(<span class="st">&quot;occ_prob&quot;</span>, <span class="st">&quot;occ_se&quot;</span>)]]</a></code></pre></div>
<p>Finally, we can map these predictions!</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="co"># project predictions</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2">r_pred_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r_pred, <span class="dt">crs =</span> map_proj<span class="op">$</span>proj4string, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)</a>
<a class="sourceLine" id="cb85-3" data-line-number="3"></a>
<a class="sourceLine" id="cb85-4" data-line-number="4"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb85-5" data-line-number="5"><span class="cf">for</span> (nm <span class="cf">in</span> <span class="kw">names</span>(r_pred)) {</a>
<a class="sourceLine" id="cb85-6" data-line-number="6">  r_plot &lt;-<span class="st"> </span>r_pred_proj[[nm]]</a>
<a class="sourceLine" id="cb85-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb85-8" data-line-number="8">  <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>))</a>
<a class="sourceLine" id="cb85-9" data-line-number="9">  <span class="co"># set up plot area</span></a>
<a class="sourceLine" id="cb85-10" data-line-number="10">  <span class="kw">plot</span>(bcr, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb85-11" data-line-number="11">  <span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb85-12" data-line-number="12"></a>
<a class="sourceLine" id="cb85-13" data-line-number="13">  <span class="co"># occupancy probability or standard error</span></a>
<a class="sourceLine" id="cb85-14" data-line-number="14">  <span class="cf">if</span> (nm <span class="op">==</span><span class="st"> &quot;occ_prob&quot;</span>) {</a>
<a class="sourceLine" id="cb85-15" data-line-number="15">    title &lt;-<span class="st"> &quot;Wood Thrush Occupancy Probability&quot;</span></a>
<a class="sourceLine" id="cb85-16" data-line-number="16">    brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">21</span>)</a>
<a class="sourceLine" id="cb85-17" data-line-number="17">    lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out =</span> <span class="dv">11</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb85-18" data-line-number="18"><span class="st">      </span><span class="kw">round</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb85-19" data-line-number="19">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb85-20" data-line-number="20">    title &lt;-<span class="st"> &quot;Wood Thrush Occupancy Uncertainty (SE)&quot;</span></a>
<a class="sourceLine" id="cb85-21" data-line-number="21">    mx &lt;-<span class="st"> </span><span class="kw">ceiling</span>(<span class="dv">1000</span> <span class="op">*</span><span class="st"> </span><span class="kw">cellStats</span>(r_plot, max)) <span class="op">/</span><span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb85-22" data-line-number="22">    brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">length.out =</span> <span class="dv">21</span>)</a>
<a class="sourceLine" id="cb85-23" data-line-number="23">    lbl_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, mx, <span class="dt">length.out =</span> <span class="dv">11</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb85-24" data-line-number="24"><span class="st">      </span><span class="kw">round</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb85-25" data-line-number="25">  }</a>
<a class="sourceLine" id="cb85-26" data-line-number="26">  pal &lt;-<span class="st"> </span><span class="kw">abundance_palette</span>(<span class="kw">length</span>(brks) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb85-27" data-line-number="27">  <span class="kw">plot</span>(r_plot, </a>
<a class="sourceLine" id="cb85-28" data-line-number="28">       <span class="dt">col =</span> pal, <span class="dt">breaks =</span> brks, </a>
<a class="sourceLine" id="cb85-29" data-line-number="29">       <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(r_plot),</a>
<a class="sourceLine" id="cb85-30" data-line-number="30">       <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb85-31" data-line-number="31">  </a>
<a class="sourceLine" id="cb85-32" data-line-number="32">  <span class="co"># borders</span></a>
<a class="sourceLine" id="cb85-33" data-line-number="33">  <span class="kw">plot</span>(bcr, <span class="dt">border =</span> <span class="st">&quot;#000000&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb85-34" data-line-number="34">  <span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb85-35" data-line-number="35">  <span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb85-36" data-line-number="36">  <span class="kw">box</span>()</a>
<a class="sourceLine" id="cb85-37" data-line-number="37">  </a>
<a class="sourceLine" id="cb85-38" data-line-number="38">  <span class="co"># legend</span></a>
<a class="sourceLine" id="cb85-39" data-line-number="39">  <span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>, <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb85-40" data-line-number="40">  <span class="kw">image.plot</span>(<span class="dt">zlim =</span> <span class="kw">range</span>(brks), <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb85-41" data-line-number="41">             <span class="dt">breaks =</span> brks, <span class="dt">col =</span> pal,</a>
<a class="sourceLine" id="cb85-42" data-line-number="42">             <span class="dt">smallplot =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>),</a>
<a class="sourceLine" id="cb85-43" data-line-number="43">             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb85-44" data-line-number="44">             <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">at =</span> lbl_brks, <span class="dt">labels =</span> lbl_brks,</a>
<a class="sourceLine" id="cb85-45" data-line-number="45">                              <span class="dt">fg =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col.axis =</span> <span class="st">&quot;black&quot;</span>,</a>
<a class="sourceLine" id="cb85-46" data-line-number="46">                              <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd.ticks =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb85-47" data-line-number="47">                              <span class="dt">padj =</span> <span class="fl">-1.5</span>),</a>
<a class="sourceLine" id="cb85-48" data-line-number="48">             <span class="dt">legend.args =</span> <span class="kw">list</span>(<span class="dt">text =</span> title,</a>
<a class="sourceLine" id="cb85-49" data-line-number="49">                                <span class="dt">side =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>,</a>
<a class="sourceLine" id="cb85-50" data-line-number="50">                                <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">line =</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb85-51" data-line-number="51">}</a></code></pre></div>
<p><img src="ebp-workshop_files/figure-html/occupancy-predict-map-1.png" width="\textwidth" style="display: block; margin: auto;" /></p>
</div>
<div id="occupancy-exercises" class="section level2">
<h2><span class="header-section-number">11.4</span> Exercises</h2>
<p>Now that you’ve completed this lesson, try modifying your script to complete at least one of the following exercises:</p>
<ol style="list-style-type: decimal">
<li><p>Try sampling more than a single checklist per grid cell in the spatiotemporal sampling. How does that affect model fit and predictions?</p></li>
<li><p>What happens to the size of dataset if you only use stationary counts, or reduce the distance traveled to 1 km? How does it impact the results? How does the different input data affect your interpretation of the results?</p></li>
<li><p>What happens to the size of the dataset if you allow repeat visits to be by multiple observers? How does this impact the results.</p></li>
<li><p>Produce a map based on model averaged predictions. Note that making these predictions may take up to an hour.</p></li>
</ol>

</div>
</div>
<script>
var coll = document.getElementsByClassName("solution");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}
</script>
            </section>

          </div>
        </div>
      </div>
<a href="encounter.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mstrimas/ebp-workshop/edit/master/11_occupancy.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
